<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Importar XML - ICMS ST</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      color: #333;
      padding: 0;
      margin: 0;
    }
    header {
      background-color: #000;
      color: #f1c40f;
      display: flex;
      align-items: center;
      padding: 10px 20px;
    }
    header img {
      height: 50px;
      margin-right: 20px;
    }
    header h1 {
      font-size: 1.5rem;
      margin: 0;
    }
    .upload-section {
      text-align: center;
      margin: 20px 0;
    }
    button {
      padding: 10px 20px;
      background-color: #f1c40f;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
    }
    input[type="file"] {
      display: none;
    }
    .info-box {
      display: flex;
      justify-content: space-around;
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 10px;
      margin: 20px;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 0 0 30px 0;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #333;
      color: #f1c40f;
    }
    tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    .highlight-imposto {
      background-color: #ffdddd;
      font-weight: bold;
    }
    .highlight-custo {
      background-color: #ddffdd;
      font-weight: bold;
    }
    footer {
      background-color: #333;
      color: #fff;
      text-align: center;
      padding: 10px;
    }
  </style>
</head>
<body>
  <header>
    <img src="img/logo.jpg" alt="Logo Dom√≠nio Farma">
    <h1>C√°lculo ICMS ST - Exclusivo para Farm√°cias</h1>
  </header>

  <div class="upload-section">
    <input type="file" id="xmlFileInput" accept=".xml">
    <button onclick="document.getElementById('xmlFileInput').click()">Selecionar XML</button>
  </div>

  <div class="info-box">
    <span id="fornecedorInfo">Fornecedor: -</span>
    <span id="notaInfo">Nota Fiscal: -</span>
    <span id="totalImpostoInfo">Total Imposto: R$ 0,00</span>
  </div>
  <div id="interestadualMsg" style="display:none;color:#856404;background-color:#fff3cd;border:1px solid #ffeeba;padding:5px;margin:10px;text-align:center"></div>

  <table id="productTable">
    <thead>
      <tr>
        <th>Descri√ß√£o</th>
        <th>CFOP</th>
        <th>CST</th>
        <th>NCM</th>
        <th>R$ Total Produto</th>
        <th>Outros</th>
        <th>IPI</th>
        <th>Desconto</th>
        <th>Quantidade</th>
        <th>Categoria</th>
        <th class="highlight-imposto">R$ Imposto</th>
        <th>Total</th>
        <th class="highlight-custo">Custo Final</th>
        <th>% Efetivo</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="legal-info" style="background:#fff8dc;border:1px solid #d7c59a;padding:10px;margin:20px;">
    <strong>üìå Por que farm√°cias pagam esse ICMS antecipado?</strong>
    <p>Conforme Art. 294 do Regulamento do ICMS da Bahia, farm√°cias, drogarias e casas de produtos naturais devem recolher antecipadamente o ICMS nas compras de produtos n√£o alcan√ßados pela substitui√ß√£o tribut√°ria. Nesses casos, a base de c√°lculo √© ajustada por uma Margem de Valor Agregado (MVA), conforme previsto nos ¬ß¬ß 14 e 17 do art. 289.</p>
    <p>Nas aquisi√ß√µes interestaduais, a MVA deve ser ajustada com base na f√≥rmula legal, o que pode aumentar o valor do imposto.</p>
    <p><strong>Exemplos de MVA para aquisi√ß√µes internas:</strong><br>
    G√™neros aliment√≠cios: 50%<br>
    Perfumarias e higiene pessoal: 60%<br>
    Eletrodom√©sticos: 20%<br>
    J√≥ias e rel√≥gios: 70%<br>
    Outras mercadorias: 40%</p>
    <p>‚ö†Ô∏è Essa sistem√°tica √© espec√≠fica para farm√°cias e garante a tributa√ß√£o do ICMS mesmo quando a mercadoria n√£o vem com substitui√ß√£o tribut√°ria do fornecedor.</p>
  </div>

  <footer>
    Todos os direitos reservados Dom√≠nio Farma Contabilidade | site: dominiofarma.com | Suporte: 74 99151-2553
  </footer>

  <script>
    let ncmMvaMap = {};
    const ALQ_FIXA = 0.205;

    fetch('https://opensheet.vercel.app/1TKysjAxeh72sSwAsa7qutZ1SUUvpazAgCNNlsMx-H00/P%C3%A1gina1')
      .then(res => res.json())
      .then(data => {
        ncmMvaMap = {};
        data.forEach(item => {
          ncmMvaMap[item.prefixo] = {
            descricao: item.descricao,
            mva: parseFloat(item.mva)
          };
        });
      });

    const interestadualBox = document.getElementById('interestadualMsg');
    document.getElementById('xmlFileInput').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(e.target.result, 'text/xml');
        const products = xmlDoc.getElementsByTagName('prod');
        const tbody = document.querySelector('#productTable tbody');
        tbody.innerHTML = '';
        interestadualBox.style.display = 'none';
        let totalImpostoNota = 0;
        let msgSet = false;

        const fornecedor = xmlDoc.querySelector('emit > xNome')?.textContent || '-';
        const numeroNota = xmlDoc.querySelector('ide > nNF')?.textContent || '-';
        document.getElementById('fornecedorInfo').textContent = `Fornecedor: ${fornecedor}`;
        document.getElementById('notaInfo').textContent = `Nota Fiscal: ${numeroNota}`;

        const CRT = xmlDoc.getElementsByTagName('CRT')[0]?.textContent || '';

        for (let i = 0; i < products.length; i++) {
          const prod = products[i];
          const nome = prod.getElementsByTagName('xProd')[0]?.textContent || 'Produto';
          const qtd = parseFloat(prod.getElementsByTagName('qCom')[0]?.textContent || '0');
          const valorProd = parseFloat(prod.getElementsByTagName('vProd')[0]?.textContent || '0');
          const frete = parseFloat(prod.getElementsByTagName('vFrete')[0]?.textContent || '0');
          const outros = parseFloat(prod.getElementsByTagName('vOutro')[0]?.textContent || '0');
          const ipi = parseFloat(prod.getElementsByTagName('vIPI')[0]?.textContent || '0');
          const desconto = parseFloat(prod.getElementsByTagName('vDesc')[0]?.textContent || '0');
          const cfop = prod.getElementsByTagName('CFOP')[0]?.textContent || '';
          const ncm = prod.getElementsByTagName('NCM')[0]?.textContent || '00000000';
          const prefixo = ncm.substring(0, 4);
          const categoria = ncmMvaMap[prefixo];

          const impostoTag = prod.parentNode.querySelector('ICMS, ICMSSN101, ICMSSN102');
          let cst = '000';
          let vICMS = 0;
          let alqInter = 0.12;
          if (impostoTag) {
            const cstTag = impostoTag.querySelector('CST') || impostoTag.querySelector('CSOSN');
            if (cstTag) cst = cstTag.textContent.trim();
            const vICMSTag = impostoTag.querySelector('vICMS');
            if (vICMSTag) vICMS = parseFloat(vICMSTag.textContent);
            const alqTag = impostoTag.querySelector('pICMS');
            if (alqTag) alqInter = parseFloat(alqTag.textContent) / 100;
          }

          let row = tbody.insertRow();
          row.insertCell(0).textContent = nome;
          row.insertCell(1).textContent = cfop;
          row.insertCell(2).textContent = cst;
          row.insertCell(3).textContent = ncm;
          row.insertCell(4).textContent = valorProd.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
          row.insertCell(5).textContent = outros.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
          row.insertCell(6).textContent = ipi.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
          row.insertCell(7).textContent = desconto.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
          row.insertCell(8).textContent = qtd;

          const categoriaCell = row.insertCell(9);
          const impostoCell = row.insertCell(10);
          const totalCell = row.insertCell(11);
          const custoCell = row.insertCell(12);
          const efetivoCell = row.insertCell(13);

          const baseCalculo = valorProd + frete + ipi + outros - desconto;

          if (!categoria) {
            categoriaCell.textContent = 'NCM n√£o cadastrada, solicite ao suporte';
            impostoCell.textContent = 'Erro';
            totalCell.textContent = 'Erro';
            custoCell.textContent = 'Erro';
            efetivoCell.textContent = 'Erro';
          } else if (CRT === '1') {
            categoriaCell.textContent = 'Fornecedor do Simples Nacional, verifique com a contabilidade o imposto da nota';
            impostoCell.textContent = '-';
            totalCell.textContent = '-';
            custoCell.textContent = baseCalculo.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            custoCell.className = 'highlight-custo';
            efetivoCell.textContent = '-';
          } else if (CRT === '3' && ['10', '40', '41', '60'].includes(cst.slice(-2))) {
            const finalCST = cst.slice(-2);
            if (finalCST === '10' || finalCST === '60') categoriaCell.textContent = 'ICMS cobrado anteriormente';
            if (finalCST === '40') categoriaCell.textContent = 'Produto isento de ICMS';
            if (finalCST === '41') categoriaCell.textContent = 'Produto n√£o tributado';
            impostoCell.textContent = '-';
            totalCell.textContent = '-';
            custoCell.textContent = baseCalculo.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            custoCell.className = 'highlight-custo';
            efetivoCell.textContent = '-';
          } else {
            const mvaOriginal = categoria?.mva || 0;
            const mvaAjustada = cfop.startsWith('6')
              ? (((1 + mvaOriginal) * (1 - alqInter)) / (1 - ALQ_FIXA)) - 1
              : mvaOriginal;
            if (cfop.startsWith('6') && !msgSet) {
              interestadualBox.textContent = `‚ö†Ô∏è O fornecedor √© de fora do estado. A al√≠quota foi ajustada com base na MVA Ajustada: ${(mvaAjustada * 100).toFixed(2)}%.`;
              interestadualBox.style.display = 'block';
              msgSet = true;
            }

            let icmsST = ((baseCalculo * (1 + mvaAjustada)) * ALQ_FIXA) - vICMS;
            totalImpostoNota += icmsST;

            let total = baseCalculo + icmsST;
            let custoFinal = qtd > 0 ? total / qtd : 0;
            let percEfetivo = valorProd > 0 ? (icmsST / valorProd) * 100 : 0;

            categoriaCell.textContent = categoria?.descricao || 'NCM n√£o cadastrada, solicite ao suporte';

            impostoCell.textContent = icmsST.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            impostoCell.className = 'highlight-imposto';
            totalCell.textContent = total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            custoCell.textContent = custoFinal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            custoCell.className = 'highlight-custo';
            efetivoCell.textContent = percEfetivo.toFixed(2) + '%';
          }
        }

        document.getElementById('totalImpostoInfo').textContent = `Total Imposto: ${totalImpostoNota.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`;
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>
